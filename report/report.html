<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>&#x7CFB;&#x7EDF;&#x6574;&#x4F53;&#x67B6;&#x6784;</title>
        <style>
/* From extension vscode.markdown-math */
@font-face{font-family:KaTeX_AMS;src:url(fonts/KaTeX_AMS-Regular.woff2) format("woff2"),url(fonts/KaTeX_AMS-Regular.woff) format("woff"),url(fonts/KaTeX_AMS-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Caligraphic;src:url(fonts/KaTeX_Caligraphic-Bold.woff2) format("woff2"),url(fonts/KaTeX_Caligraphic-Bold.woff) format("woff"),url(fonts/KaTeX_Caligraphic-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:KaTeX_Caligraphic;src:url(fonts/KaTeX_Caligraphic-Regular.woff2) format("woff2"),url(fonts/KaTeX_Caligraphic-Regular.woff) format("woff"),url(fonts/KaTeX_Caligraphic-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Fraktur;src:url(fonts/KaTeX_Fraktur-Bold.woff2) format("woff2"),url(fonts/KaTeX_Fraktur-Bold.woff) format("woff"),url(fonts/KaTeX_Fraktur-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:KaTeX_Fraktur;src:url(fonts/KaTeX_Fraktur-Regular.woff2) format("woff2"),url(fonts/KaTeX_Fraktur-Regular.woff) format("woff"),url(fonts/KaTeX_Fraktur-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-Bold.woff2) format("woff2"),url(fonts/KaTeX_Main-Bold.woff) format("woff"),url(fonts/KaTeX_Main-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-BoldItalic.woff2) format("woff2"),url(fonts/KaTeX_Main-BoldItalic.woff) format("woff"),url(fonts/KaTeX_Main-BoldItalic.ttf) format("truetype");font-weight:700;font-style:italic}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-Italic.woff2) format("woff2"),url(fonts/KaTeX_Main-Italic.woff) format("woff"),url(fonts/KaTeX_Main-Italic.ttf) format("truetype");font-weight:400;font-style:italic}@font-face{font-family:KaTeX_Main;src:url(fonts/KaTeX_Main-Regular.woff2) format("woff2"),url(fonts/KaTeX_Main-Regular.woff) format("woff"),url(fonts/KaTeX_Main-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Math;src:url(fonts/KaTeX_Math-BoldItalic.woff2) format("woff2"),url(fonts/KaTeX_Math-BoldItalic.woff) format("woff"),url(fonts/KaTeX_Math-BoldItalic.ttf) format("truetype");font-weight:700;font-style:italic}@font-face{font-family:KaTeX_Math;src:url(fonts/KaTeX_Math-Italic.woff2) format("woff2"),url(fonts/KaTeX_Math-Italic.woff) format("woff"),url(fonts/KaTeX_Math-Italic.ttf) format("truetype");font-weight:400;font-style:italic}@font-face{font-family:"KaTeX_SansSerif";src:url(fonts/KaTeX_SansSerif-Bold.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Bold.woff) format("woff"),url(fonts/KaTeX_SansSerif-Bold.ttf) format("truetype");font-weight:700;font-style:normal}@font-face{font-family:"KaTeX_SansSerif";src:url(fonts/KaTeX_SansSerif-Italic.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Italic.woff) format("woff"),url(fonts/KaTeX_SansSerif-Italic.ttf) format("truetype");font-weight:400;font-style:italic}@font-face{font-family:"KaTeX_SansSerif";src:url(fonts/KaTeX_SansSerif-Regular.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Regular.woff) format("woff"),url(fonts/KaTeX_SansSerif-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Script;src:url(fonts/KaTeX_Script-Regular.woff2) format("woff2"),url(fonts/KaTeX_Script-Regular.woff) format("woff"),url(fonts/KaTeX_Script-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size1;src:url(fonts/KaTeX_Size1-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size1-Regular.woff) format("woff"),url(fonts/KaTeX_Size1-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size2;src:url(fonts/KaTeX_Size2-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size2-Regular.woff) format("woff"),url(fonts/KaTeX_Size2-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size3;src:url(fonts/KaTeX_Size3-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size3-Regular.woff) format("woff"),url(fonts/KaTeX_Size3-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Size4;src:url(fonts/KaTeX_Size4-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size4-Regular.woff) format("woff"),url(fonts/KaTeX_Size4-Regular.ttf) format("truetype");font-weight:400;font-style:normal}@font-face{font-family:KaTeX_Typewriter;src:url(fonts/KaTeX_Typewriter-Regular.woff2) format("woff2"),url(fonts/KaTeX_Typewriter-Regular.woff) format("woff"),url(fonts/KaTeX_Typewriter-Regular.ttf) format("truetype");font-weight:400;font-style:normal}.katex{font:normal 1.21em KaTeX_Main,Times New Roman,serif;line-height:1.2;text-indent:0;text-rendering:auto;border-color:currentColor}.katex *{-ms-high-contrast-adjust:none!important}.katex .katex-version:after{content:"0.13.0"}.katex .katex-mathml{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}.katex .katex-html>.newline{display:block}.katex .base{position:relative;white-space:nowrap;width:-webkit-min-content;width:-moz-min-content;width:min-content}.katex .base,.katex .strut{display:inline-block}.katex .textbf{font-weight:700}.katex .textit{font-style:italic}.katex .textrm{font-family:KaTeX_Main}.katex .textsf{font-family:KaTeX_SansSerif}.katex .texttt{font-family:KaTeX_Typewriter}.katex .mathnormal{font-family:KaTeX_Math;font-style:italic}.katex .mathit{font-family:KaTeX_Main;font-style:italic}.katex .mathrm{font-style:normal}.katex .mathbf{font-family:KaTeX_Main;font-weight:700}.katex .boldsymbol{font-family:KaTeX_Math;font-weight:700;font-style:italic}.katex .amsrm,.katex .mathbb,.katex .textbb{font-family:KaTeX_AMS}.katex .mathcal{font-family:KaTeX_Caligraphic}.katex .mathfrak,.katex .textfrak{font-family:KaTeX_Fraktur}.katex .mathtt{font-family:KaTeX_Typewriter}.katex .mathscr,.katex .textscr{font-family:KaTeX_Script}.katex .mathsf,.katex .textsf{font-family:KaTeX_SansSerif}.katex .mathboldsf,.katex .textboldsf{font-family:KaTeX_SansSerif;font-weight:700}.katex .mathitsf,.katex .textitsf{font-family:KaTeX_SansSerif;font-style:italic}.katex .mainrm{font-family:KaTeX_Main;font-style:normal}.katex .vlist-t{display:inline-table;table-layout:fixed;border-collapse:collapse}.katex .vlist-r{display:table-row}.katex .vlist{display:table-cell;vertical-align:bottom;position:relative}.katex .vlist>span{display:block;height:0;position:relative}.katex .vlist>span>span{display:inline-block}.katex .vlist>span>.pstrut{overflow:hidden;width:0}.katex .vlist-t2{margin-right:-2px}.katex .vlist-s{display:table-cell;vertical-align:bottom;font-size:1px;width:2px;min-width:2px}.katex .vbox{display:inline-flex;flex-direction:column;align-items:baseline}.katex .hbox{width:100%}.katex .hbox,.katex .thinbox{display:inline-flex;flex-direction:row}.katex .thinbox{width:0;max-width:0}.katex .msupsub{text-align:left}.katex .mfrac>span>span{text-align:center}.katex .mfrac .frac-line{display:inline-block;width:100%;border-bottom-style:solid}.katex .hdashline,.katex .hline,.katex .mfrac .frac-line,.katex .overline .overline-line,.katex .rule,.katex .underline .underline-line{min-height:1px}.katex .mspace{display:inline-block}.katex .clap,.katex .llap,.katex .rlap{width:0;position:relative}.katex .clap>.inner,.katex .llap>.inner,.katex .rlap>.inner{position:absolute}.katex .clap>.fix,.katex .llap>.fix,.katex .rlap>.fix{display:inline-block}.katex .llap>.inner{right:0}.katex .clap>.inner,.katex .rlap>.inner{left:0}.katex .clap>.inner>span{margin-left:-50%;margin-right:50%}.katex .rule{display:inline-block;border:0 solid;position:relative}.katex .hline,.katex .overline .overline-line,.katex .underline .underline-line{display:inline-block;width:100%;border-bottom-style:solid}.katex .hdashline{display:inline-block;width:100%;border-bottom-style:dashed}.katex .sqrt>.root{margin-left:.27777778em;margin-right:-.55555556em}.katex .fontsize-ensurer.reset-size1.size1,.katex .sizing.reset-size1.size1{font-size:1em}.katex .fontsize-ensurer.reset-size1.size2,.katex .sizing.reset-size1.size2{font-size:1.2em}.katex .fontsize-ensurer.reset-size1.size3,.katex .sizing.reset-size1.size3{font-size:1.4em}.katex .fontsize-ensurer.reset-size1.size4,.katex .sizing.reset-size1.size4{font-size:1.6em}.katex .fontsize-ensurer.reset-size1.size5,.katex .sizing.reset-size1.size5{font-size:1.8em}.katex .fontsize-ensurer.reset-size1.size6,.katex .sizing.reset-size1.size6{font-size:2em}.katex .fontsize-ensurer.reset-size1.size7,.katex .sizing.reset-size1.size7{font-size:2.4em}.katex .fontsize-ensurer.reset-size1.size8,.katex .sizing.reset-size1.size8{font-size:2.88em}.katex .fontsize-ensurer.reset-size1.size9,.katex .sizing.reset-size1.size9{font-size:3.456em}.katex .fontsize-ensurer.reset-size1.size10,.katex .sizing.reset-size1.size10{font-size:4.148em}.katex .fontsize-ensurer.reset-size1.size11,.katex .sizing.reset-size1.size11{font-size:4.976em}.katex .fontsize-ensurer.reset-size2.size1,.katex .sizing.reset-size2.size1{font-size:.83333333em}.katex .fontsize-ensurer.reset-size2.size2,.katex .sizing.reset-size2.size2{font-size:1em}.katex .fontsize-ensurer.reset-size2.size3,.katex .sizing.reset-size2.size3{font-size:1.16666667em}.katex .fontsize-ensurer.reset-size2.size4,.katex .sizing.reset-size2.size4{font-size:1.33333333em}.katex .fontsize-ensurer.reset-size2.size5,.katex .sizing.reset-size2.size5{font-size:1.5em}.katex .fontsize-ensurer.reset-size2.size6,.katex .sizing.reset-size2.size6{font-size:1.66666667em}.katex .fontsize-ensurer.reset-size2.size7,.katex .sizing.reset-size2.size7{font-size:2em}.katex .fontsize-ensurer.reset-size2.size8,.katex .sizing.reset-size2.size8{font-size:2.4em}.katex .fontsize-ensurer.reset-size2.size9,.katex .sizing.reset-size2.size9{font-size:2.88em}.katex .fontsize-ensurer.reset-size2.size10,.katex .sizing.reset-size2.size10{font-size:3.45666667em}.katex .fontsize-ensurer.reset-size2.size11,.katex .sizing.reset-size2.size11{font-size:4.14666667em}.katex .fontsize-ensurer.reset-size3.size1,.katex .sizing.reset-size3.size1{font-size:.71428571em}.katex .fontsize-ensurer.reset-size3.size2,.katex .sizing.reset-size3.size2{font-size:.85714286em}.katex .fontsize-ensurer.reset-size3.size3,.katex .sizing.reset-size3.size3{font-size:1em}.katex .fontsize-ensurer.reset-size3.size4,.katex .sizing.reset-size3.size4{font-size:1.14285714em}.katex .fontsize-ensurer.reset-size3.size5,.katex .sizing.reset-size3.size5{font-size:1.28571429em}.katex .fontsize-ensurer.reset-size3.size6,.katex .sizing.reset-size3.size6{font-size:1.42857143em}.katex .fontsize-ensurer.reset-size3.size7,.katex .sizing.reset-size3.size7{font-size:1.71428571em}.katex .fontsize-ensurer.reset-size3.size8,.katex .sizing.reset-size3.size8{font-size:2.05714286em}.katex .fontsize-ensurer.reset-size3.size9,.katex .sizing.reset-size3.size9{font-size:2.46857143em}.katex .fontsize-ensurer.reset-size3.size10,.katex .sizing.reset-size3.size10{font-size:2.96285714em}.katex .fontsize-ensurer.reset-size3.size11,.katex .sizing.reset-size3.size11{font-size:3.55428571em}.katex .fontsize-ensurer.reset-size4.size1,.katex .sizing.reset-size4.size1{font-size:.625em}.katex .fontsize-ensurer.reset-size4.size2,.katex .sizing.reset-size4.size2{font-size:.75em}.katex .fontsize-ensurer.reset-size4.size3,.katex .sizing.reset-size4.size3{font-size:.875em}.katex .fontsize-ensurer.reset-size4.size4,.katex .sizing.reset-size4.size4{font-size:1em}.katex .fontsize-ensurer.reset-size4.size5,.katex .sizing.reset-size4.size5{font-size:1.125em}.katex .fontsize-ensurer.reset-size4.size6,.katex .sizing.reset-size4.size6{font-size:1.25em}.katex .fontsize-ensurer.reset-size4.size7,.katex .sizing.reset-size4.size7{font-size:1.5em}.katex .fontsize-ensurer.reset-size4.size8,.katex .sizing.reset-size4.size8{font-size:1.8em}.katex .fontsize-ensurer.reset-size4.size9,.katex .sizing.reset-size4.size9{font-size:2.16em}.katex .fontsize-ensurer.reset-size4.size10,.katex .sizing.reset-size4.size10{font-size:2.5925em}.katex .fontsize-ensurer.reset-size4.size11,.katex .sizing.reset-size4.size11{font-size:3.11em}.katex .fontsize-ensurer.reset-size5.size1,.katex .sizing.reset-size5.size1{font-size:.55555556em}.katex .fontsize-ensurer.reset-size5.size2,.katex .sizing.reset-size5.size2{font-size:.66666667em}.katex .fontsize-ensurer.reset-size5.size3,.katex .sizing.reset-size5.size3{font-size:.77777778em}.katex .fontsize-ensurer.reset-size5.size4,.katex .sizing.reset-size5.size4{font-size:.88888889em}.katex .fontsize-ensurer.reset-size5.size5,.katex .sizing.reset-size5.size5{font-size:1em}.katex .fontsize-ensurer.reset-size5.size6,.katex .sizing.reset-size5.size6{font-size:1.11111111em}.katex .fontsize-ensurer.reset-size5.size7,.katex .sizing.reset-size5.size7{font-size:1.33333333em}.katex .fontsize-ensurer.reset-size5.size8,.katex .sizing.reset-size5.size8{font-size:1.6em}.katex .fontsize-ensurer.reset-size5.size9,.katex .sizing.reset-size5.size9{font-size:1.92em}.katex .fontsize-ensurer.reset-size5.size10,.katex .sizing.reset-size5.size10{font-size:2.30444444em}.katex .fontsize-ensurer.reset-size5.size11,.katex .sizing.reset-size5.size11{font-size:2.76444444em}.katex .fontsize-ensurer.reset-size6.size1,.katex .sizing.reset-size6.size1{font-size:.5em}.katex .fontsize-ensurer.reset-size6.size2,.katex .sizing.reset-size6.size2{font-size:.6em}.katex .fontsize-ensurer.reset-size6.size3,.katex .sizing.reset-size6.size3{font-size:.7em}.katex .fontsize-ensurer.reset-size6.size4,.katex .sizing.reset-size6.size4{font-size:.8em}.katex .fontsize-ensurer.reset-size6.size5,.katex .sizing.reset-size6.size5{font-size:.9em}.katex .fontsize-ensurer.reset-size6.size6,.katex .sizing.reset-size6.size6{font-size:1em}.katex .fontsize-ensurer.reset-size6.size7,.katex .sizing.reset-size6.size7{font-size:1.2em}.katex .fontsize-ensurer.reset-size6.size8,.katex .sizing.reset-size6.size8{font-size:1.44em}.katex .fontsize-ensurer.reset-size6.size9,.katex .sizing.reset-size6.size9{font-size:1.728em}.katex .fontsize-ensurer.reset-size6.size10,.katex .sizing.reset-size6.size10{font-size:2.074em}.katex .fontsize-ensurer.reset-size6.size11,.katex .sizing.reset-size6.size11{font-size:2.488em}.katex .fontsize-ensurer.reset-size7.size1,.katex .sizing.reset-size7.size1{font-size:.41666667em}.katex .fontsize-ensurer.reset-size7.size2,.katex .sizing.reset-size7.size2{font-size:.5em}.katex .fontsize-ensurer.reset-size7.size3,.katex .sizing.reset-size7.size3{font-size:.58333333em}.katex .fontsize-ensurer.reset-size7.size4,.katex .sizing.reset-size7.size4{font-size:.66666667em}.katex .fontsize-ensurer.reset-size7.size5,.katex .sizing.reset-size7.size5{font-size:.75em}.katex .fontsize-ensurer.reset-size7.size6,.katex .sizing.reset-size7.size6{font-size:.83333333em}.katex .fontsize-ensurer.reset-size7.size7,.katex .sizing.reset-size7.size7{font-size:1em}.katex .fontsize-ensurer.reset-size7.size8,.katex .sizing.reset-size7.size8{font-size:1.2em}.katex .fontsize-ensurer.reset-size7.size9,.katex .sizing.reset-size7.size9{font-size:1.44em}.katex .fontsize-ensurer.reset-size7.size10,.katex .sizing.reset-size7.size10{font-size:1.72833333em}.katex .fontsize-ensurer.reset-size7.size11,.katex .sizing.reset-size7.size11{font-size:2.07333333em}.katex .fontsize-ensurer.reset-size8.size1,.katex .sizing.reset-size8.size1{font-size:.34722222em}.katex .fontsize-ensurer.reset-size8.size2,.katex .sizing.reset-size8.size2{font-size:.41666667em}.katex .fontsize-ensurer.reset-size8.size3,.katex .sizing.reset-size8.size3{font-size:.48611111em}.katex .fontsize-ensurer.reset-size8.size4,.katex .sizing.reset-size8.size4{font-size:.55555556em}.katex .fontsize-ensurer.reset-size8.size5,.katex .sizing.reset-size8.size5{font-size:.625em}.katex .fontsize-ensurer.reset-size8.size6,.katex .sizing.reset-size8.size6{font-size:.69444444em}.katex .fontsize-ensurer.reset-size8.size7,.katex .sizing.reset-size8.size7{font-size:.83333333em}.katex .fontsize-ensurer.reset-size8.size8,.katex .sizing.reset-size8.size8{font-size:1em}.katex .fontsize-ensurer.reset-size8.size9,.katex .sizing.reset-size8.size9{font-size:1.2em}.katex .fontsize-ensurer.reset-size8.size10,.katex .sizing.reset-size8.size10{font-size:1.44027778em}.katex .fontsize-ensurer.reset-size8.size11,.katex .sizing.reset-size8.size11{font-size:1.72777778em}.katex .fontsize-ensurer.reset-size9.size1,.katex .sizing.reset-size9.size1{font-size:.28935185em}.katex .fontsize-ensurer.reset-size9.size2,.katex .sizing.reset-size9.size2{font-size:.34722222em}.katex .fontsize-ensurer.reset-size9.size3,.katex .sizing.reset-size9.size3{font-size:.40509259em}.katex .fontsize-ensurer.reset-size9.size4,.katex .sizing.reset-size9.size4{font-size:.46296296em}.katex .fontsize-ensurer.reset-size9.size5,.katex .sizing.reset-size9.size5{font-size:.52083333em}.katex .fontsize-ensurer.reset-size9.size6,.katex .sizing.reset-size9.size6{font-size:.5787037em}.katex .fontsize-ensurer.reset-size9.size7,.katex .sizing.reset-size9.size7{font-size:.69444444em}.katex .fontsize-ensurer.reset-size9.size8,.katex .sizing.reset-size9.size8{font-size:.83333333em}.katex .fontsize-ensurer.reset-size9.size9,.katex .sizing.reset-size9.size9{font-size:1em}.katex .fontsize-ensurer.reset-size9.size10,.katex .sizing.reset-size9.size10{font-size:1.20023148em}.katex .fontsize-ensurer.reset-size9.size11,.katex .sizing.reset-size9.size11{font-size:1.43981481em}.katex .fontsize-ensurer.reset-size10.size1,.katex .sizing.reset-size10.size1{font-size:.24108004em}.katex .fontsize-ensurer.reset-size10.size2,.katex .sizing.reset-size10.size2{font-size:.28929605em}.katex .fontsize-ensurer.reset-size10.size3,.katex .sizing.reset-size10.size3{font-size:.33751205em}.katex .fontsize-ensurer.reset-size10.size4,.katex .sizing.reset-size10.size4{font-size:.38572806em}.katex .fontsize-ensurer.reset-size10.size5,.katex .sizing.reset-size10.size5{font-size:.43394407em}.katex .fontsize-ensurer.reset-size10.size6,.katex .sizing.reset-size10.size6{font-size:.48216008em}.katex .fontsize-ensurer.reset-size10.size7,.katex .sizing.reset-size10.size7{font-size:.57859209em}.katex .fontsize-ensurer.reset-size10.size8,.katex .sizing.reset-size10.size8{font-size:.69431051em}.katex .fontsize-ensurer.reset-size10.size9,.katex .sizing.reset-size10.size9{font-size:.83317261em}.katex .fontsize-ensurer.reset-size10.size10,.katex .sizing.reset-size10.size10{font-size:1em}.katex .fontsize-ensurer.reset-size10.size11,.katex .sizing.reset-size10.size11{font-size:1.19961427em}.katex .fontsize-ensurer.reset-size11.size1,.katex .sizing.reset-size11.size1{font-size:.20096463em}.katex .fontsize-ensurer.reset-size11.size2,.katex .sizing.reset-size11.size2{font-size:.24115756em}.katex .fontsize-ensurer.reset-size11.size3,.katex .sizing.reset-size11.size3{font-size:.28135048em}.katex .fontsize-ensurer.reset-size11.size4,.katex .sizing.reset-size11.size4{font-size:.32154341em}.katex .fontsize-ensurer.reset-size11.size5,.katex .sizing.reset-size11.size5{font-size:.36173633em}.katex .fontsize-ensurer.reset-size11.size6,.katex .sizing.reset-size11.size6{font-size:.40192926em}.katex .fontsize-ensurer.reset-size11.size7,.katex .sizing.reset-size11.size7{font-size:.48231511em}.katex .fontsize-ensurer.reset-size11.size8,.katex .sizing.reset-size11.size8{font-size:.57877814em}.katex .fontsize-ensurer.reset-size11.size9,.katex .sizing.reset-size11.size9{font-size:.69453376em}.katex .fontsize-ensurer.reset-size11.size10,.katex .sizing.reset-size11.size10{font-size:.83360129em}.katex .fontsize-ensurer.reset-size11.size11,.katex .sizing.reset-size11.size11{font-size:1em}.katex .delimsizing.size1{font-family:KaTeX_Size1}.katex .delimsizing.size2{font-family:KaTeX_Size2}.katex .delimsizing.size3{font-family:KaTeX_Size3}.katex .delimsizing.size4{font-family:KaTeX_Size4}.katex .delimsizing.mult .delim-size1>span{font-family:KaTeX_Size1}.katex .delimsizing.mult .delim-size4>span{font-family:KaTeX_Size4}.katex .nulldelimiter{display:inline-block;width:.12em}.katex .delimcenter,.katex .op-symbol{position:relative}.katex .op-symbol.small-op{font-family:KaTeX_Size1}.katex .op-symbol.large-op{font-family:KaTeX_Size2}.katex .accent>.vlist-t,.katex .op-limits>.vlist-t{text-align:center}.katex .accent .accent-body{position:relative}.katex .accent .accent-body:not(.accent-full){width:0}.katex .overlay{display:block}.katex .mtable .vertical-separator{display:inline-block;min-width:1px}.katex .mtable .arraycolsep{display:inline-block}.katex .mtable .col-align-c>.vlist-t{text-align:center}.katex .mtable .col-align-l>.vlist-t{text-align:left}.katex .mtable .col-align-r>.vlist-t{text-align:right}.katex .svg-align{text-align:left}.katex svg{display:block;position:absolute;width:100%;height:inherit;fill:currentColor;stroke:currentColor;fill-rule:nonzero;fill-opacity:1;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1}.katex svg path{stroke:none}.katex img{border-style:none;min-width:0;min-height:0;max-width:none;max-height:none}.katex .stretchy{width:100%;display:block;position:relative;overflow:hidden}.katex .stretchy:after,.katex .stretchy:before{content:""}.katex .hide-tail{width:100%;position:relative;overflow:hidden}.katex .halfarrow-left{position:absolute;left:0;width:50.2%;overflow:hidden}.katex .halfarrow-right{position:absolute;right:0;width:50.2%;overflow:hidden}.katex .brace-left{position:absolute;left:0;width:25.1%;overflow:hidden}.katex .brace-center{position:absolute;left:25%;width:50%;overflow:hidden}.katex .brace-right{position:absolute;right:0;width:25.1%;overflow:hidden}.katex .x-arrow-pad{padding:0 .5em}.katex .cd-arrow-pad{padding:0 .55556em 0 .27778em}.katex .mover,.katex .munder,.katex .x-arrow{text-align:center}.katex .boxpad{padding:0 .3em}.katex .fbox,.katex .fcolorbox{box-sizing:border-box;border:.04em solid}.katex .cancel-pad{padding:0 .2em}.katex .cancel-lap{margin-left:-.2em;margin-right:-.2em}.katex .sout{border-bottom-style:solid;border-bottom-width:.08em}.katex .angl{box-sizing:border-content;border-top:.049em solid;border-right:.049em solid;margin-right:.03889em}.katex .anglpad{padding:0 .03889em}.katex .eqn-num:before{counter-increment:katexEqnNo;content:"(" counter(katexEqnNo) ")"}.katex .mml-eqn-num:before{counter-increment:mmlEqnNo;content:"(" counter(mmlEqnNo) ")"}.katex .mtr-glue{width:50%}.katex .cd-vert-arrow{display:inline-block;position:relative}.katex .cd-label-left{display:inline-block;position:absolute;right:calc(50% + .3em);text-align:left}.katex .cd-label-right{display:inline-block;position:absolute;left:calc(50% + .3em);text-align:right}.katex-display{display:block;margin:1em 0;text-align:center}.katex-display>.katex{display:block;text-align:center;white-space:nowrap}.katex-display>.katex>.katex-html{display:block;position:relative}.katex-display>.katex>.katex-html>.tag{position:absolute;right:0}.katex-display.leqno>.katex>.katex-html>.tag{left:0;right:auto}.katex-display.fleqn>.katex{text-align:left;padding-left:2em}body{counter-reset:katexEqnNo mmlEqnNo}

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.katex-error {
	color: var(--vscode-editorError-foreground);
}

</style>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        
        
        
    </head>
    <body class="vscode-body vscode-light">
        <h2 id="系统整体架构">系统整体架构</h2>
<h3 id="mvc模式">MVC模式</h3>
<p>本系统采用<strong>MVC模式</strong>设计前端-后端-数据库分离的三层整体设计，以保证系统具有较好的<strong>可维护性</strong>和<strong>可扩展性</strong>。</p>
<p>整体来说，系统架构自顶而下遵顼MVC三层架构设计：</p>
<ol>
<li>View: 视图层，直接与用户交互图新界面，它对应的是系统的<em>前端</em></li>
<li>Control: 业务逻辑层，负责接收并处理视图层的输入，并利用数据层间接访问数据，它对应的是系统的<em>后端</em></li>
<li>Model: 数据层，直接与数据库交互，并为Control层提供经过封装的数据访问功能的，它对应的是系统的<em>数据库访问接口</em></li>
</ol>
<p>MVC模式具有多个优势：</p>
<ul>
<li>模块耦合度低：MVC中三层都是通过接口</li>
</ul>
<h3 id="视图层前端设计">视图层：前端设计</h3>
<p>在视图层我们采用基于现代HTML5-CSS3-ES6的技术栈以及前端框架Vue来构建特性丰富的Web2.0用户界面。</p>
<p>在视图层我们采用了基于<strong>MVVM模式</strong>的前端框架Vue.js以及Vue系列套件Vue-VueRouter-Vuex构建驱动<em>单页应用</em>。</p>
<p>我们通过复用基于Vue的组件库Vuetify来快速搭建风格统一、外观精美的基于Material Design UI设计的应用界面</p>
<p>我们引入著名的D3.js为数据可视化提供支持。</p>
<p>总的来说，我们主要的前端特性包括：</p>
<ul>
<li>基于Vue-VueRouter-Vuex的MVVM前端模块</li>
<li>基于Vuetify组件库的Material Design风格前端界面</li>
<li>基于D3.js的数据可视化模块</li>
</ul>
<h3 id="业务逻辑层后端设计">业务逻辑层：后端设计</h3>
<p>后端架构采用<em>微服务</em>架构，将系统业务构建为可以独立运行、独立测试、独立部署的微服务。</p>
<p>后端接口采用的是<em>RESTful接口</em>，将业务接口统一为无状态、标准化、缓存友好的RESTful风格接口。</p>
<p>我们基于RESTful API为系统的后台管理模块构建了一组通用的数据CRUD服务。</p>
<p>后端充当MVC中的Controller，既不直接操作数据库，也不直接渲染HTML页面，而是作为数据服务和M-V的中介模块。</p>
<p>在后端模块我们采用Python的轻量级Web框架Flask来支持基础的路由、HTTP请求响应以及Session。选用Python是快速开发，以及利用Python生态中优秀的数据分析和机器学习模块。</p>
<p>为避免后端代码直接使用SQL访问数据库，我们模仿Django框架构建了简易的ORM引擎，为后端代码提供抽象的、独立于具体数据库产品的数据库访问接口。</p>
<p>我们使用psycopg2库来在Python代码中嵌入并执行SQL语句，从而与OpenGauss数据库交互。</p>
<p>总结，我们的后端主要支持这些主要特性：</p>
<ul>
<li>基于Flask的RESTful API</li>
<li>RESTful数据管理CRUD服务</li>
<li>论坛基础功能服务</li>
<li>机器学习服务</li>
<li>数据分析服务</li>
<li>登录服务</li>
<li>简易ORM引擎</li>
<li>基于线程池的会话</li>
</ul>
<h3 id="数据库设计">数据库设计</h3>
<p>数据建模以及数据库的逻辑设计已经在前面章节完成了，这里不再赘述。</p>
<p>在数据库产品选择上，我们使用的产品是OpenGauss。由于系统没有大规模、高可用的需求，我们没有采用数据库产品的复制特性以及集群。</p>
<p>为满足业务需要，我们在数据库服务端编程的<em>触发器</em>特新来实现自动的Tag访问日志纪录</p>
<p>出于性能的考虑，做了如下额外工作：</p>
<ul>
<li>为所有unique列建立B树索引</li>
<li>基于Web应用读多写少的应用背景，我们对频繁执行的若干个连接查询建立物化视图</li>
</ul>
<h2 id="前端设计">前端设计</h2>
<h3 id="基于vuejs系列工具的前端模块">基于Vue.js系列工具的前端模块</h3>
<p>在前端设计中，我们采用基于现代HTML5-CSS3-ES6的技术栈以及前端框架Vue来构建特性丰富的Web2.0用户界面。</p>
<p>我们采用了基于<strong>MVVM模式</strong>的前端框架Vue.js以及Vue系列套件Vue-VueRouter-Vuex构建驱动<em>单页应用</em>。</p>
<p>单页应用意味着<strong>前端模块很容易迁移为桌面应用、手机App以及小程序</strong>，这正是本项目较好的可扩展性的重要体现。</p>
<p>Vue的核心特性是数据绑定以及配套的响应式渲染。通过将界面和与前端代码逻辑分离实现前端组件的<em>可复用性、可维护性和可扩展性</em>。在Vue框架中，Javascript代码基于不需要直接访问和操作DOM元素。借助Vue框架的数据绑定特性，Javascript直接操作数据，由框架响应式地将数据渲染为界面。此外，Vue将一个UI的结构、样式和逻辑封装起来，实现了前端UI组件的复用。本项目通过复用Vuetify组件库来构件界面。</p>
<p>Vue Router是实现Vue单页应用的关键部件，它利用路由匹配和组件切换实现不刷新整个页面、不向服务端重新请求整个页面的情况下的“页面”切换。通过将页面聚合到一个HTML文档中，Vue Router实现了“单页应用”，具备了将同一个前端项目输出为桌面应用、手机App、微信小程序的基础。</p>
<p>Vuex是配合Vue Router实现单页应用中跨组件状态维护的库。相比直接使用绑定<code>window</code>的全局变量，Vuex提供的状态模块可以完美嵌入Vue框架，提供响应式渲染的特性。本项目的前端登录模块以及用户登录状态的记录特性采用Vuex实现。通过在Vuex中存储当前用户的信息以及session token实现各个页面组件间记录当前登录用户的特性。</p>
<h3 id="应用界面基于vuetify组件库">应用界面：基于Vuetify组件库</h3>
<p>我们通过复用基于Vue的组件库Vuetify来快速搭建风格统一、外观精美的基于Material Design UI设计的应用界面。本项目复用了大量Vuetify组件来实现丰富的表单界面（日期选择器、文本框、选择栏）。</p>
<p>以下展示部分应用界面。完整界面参见附录和演示视频：</p>
<p>帖子列表：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\posts.PNG" alt="App View Post"></p>
<p>发帖界面：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\post_edit.PNG" alt="App View Login"></p>
<p>个人信息中心：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\user_info.PNG" alt="App View User Info"></p>
<p>数据管理界面：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage1.PNG" alt="App View Manage"></p>
<p>服务端分页：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage3.PNG" alt="App View Manage"></p>
<p>告示信息：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage5.PNG" alt="App View Manage"></p>
<p>日期选择组件：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form2.PNG" alt="App View Form"></p>
<h3 id="响应式设计">响应式设计</h3>
<p>响应式设计：利用CSS3媒介查询，自适应地根据手机、平板、PC屏幕的特点调整网页布局，从而生成跨媒介风格统一的界面的前端设计技术。</p>
<p>本项目基于Vuetify组件库的响应式栅格系统构建了跨手机-PC支持的应用界面。</p>
<h3 id="d3js数据可视化">D3.js数据可视化</h3>
<p>我们引入著名的D3.js为数据可视化提供支持。</p>
<p>D3.js是以数据为中心的可视化库，它提供从原始数据到图标信息的数据绑定，最终渲染基于SVG。</p>
<p>本项目利用D3.js实现情感分类模块和热度统计模块的图表可视化。</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\em_test3.PNG" alt="Emotion Pie"></p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\tag_list.PNG" alt="Hot Value Plot"></p>
<h3 id="数据管理后台前端模块">数据管理后台前端模块</h3>
<p>我们为本项目的数据管理后台构建了通用数据编辑组件<code>ObjectListEditor</code>和编辑表单组件<code>DialogEditor</code>实现<strong>任意模型的数据对象的编辑的通用列表和通用表</strong>。这个模块需要额外的后端服务支持。</p>
<p>数据管理界面：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage1.PNG" alt="App View Manage"></p>
<p>右侧是数据对象模型列表，每个模型对应一个数据库的表。利用模型包含的元数据，前端可以自动选择适当的组件构造数据列表和表单：</p>
<p>告示信息：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage5.PNG" alt="App View Manage"></p>
<p>新建对象表单：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form1.PNG" alt="App View Form"></p>
<p>日期选择组件：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form2.PNG" alt="App View Form"></p>
<h2 id="后端技术选型">后端技术选型</h2>
<ul>
<li>选择Python作为后端开发语言的原因
<ul>
<li>快速开发与快速迭代</li>
<li>“胶水语言”，与多种编程语言具有良好的互操作性</li>
<li>与机器学习算法无缝衔接</li>
<li>具备丰富的数据分析工具</li>
</ul>
</li>
<li>选择Flask的原因：
<ul>
<li>轻量：Flask只包含了基本的HTTP请求/响应解析和路由映射模块</li>
<li>功能齐全：具备了动态路由映射、基于cookie-session的客户端状态、鉴权、JSON序列化、模板等基本功能</li>
<li>高度定制：为了符合本项目作业要求，我们需要自己开发数据库连接的部分。相比Django绑定数据库连接模块，Flask可以自由替换。</li>
</ul>
</li>
</ul>
<h2 id="后端数据访问抽象">后端数据访问抽象</h2>
<p>出于以下原因，我们不希望直接在后端业务代码中编写SQL语句：</p>
<ol>
<li>可维护性：直接使用SQL的后端代码中，业务处理逻辑和数据存取逻辑是混杂在一起的，增大了系统维护难度和软件复杂度。</li>
<li>可扩展性：
<ul>
<li>若直接编写SQL语句，后端业务代码将与<strong>特定的SQL数据库产品绑定</strong>，难以迁移到其他数据库产品上。</li>
<li>若直接编写SQL语句，将限制后端将来<strong>迁移到NoSQL数据库上的可能性</strong>。</li>
</ul>
</li>
<li>安全性：直接使用字符串模板构造SQL代码容易出现<em>SQL注入漏洞</em>。使用间接操作允许我们灵活地添加验证/转义处理。</li>
<li>易用性：标准数据库接口的返回都是元组，将元组绑定到一定的对象上更便于业务逻辑层的代码使用</li>
<li>自省能力：直接使用数据库接口比较难获取表的元数据，难以产生灵活的前端模块</li>
</ol>
<p>综上，我们需要为后端代码提供适当的数据访问抽象。</p>
<p>我们模仿Django构建了一个简易的<strong>ORM引擎</strong>作为这一抽象。</p>
<h3 id="orm引擎抽象的数据库访问接口">ORM引擎：抽象的数据库访问接口</h3>
<p>对象关系映射（英语：Object Relational Mapping），是一种程序设计技术，用于实现面向对象编程语言里不同类型系统的数据之间的转换。从效果上说，它其实是创建了一个可在编程语言里使用的“虚拟对象数据库”。</p>
<p>本项目设计的简易ORM库（以下简称ORM）是后端代码的抽象的数据库访问接口。</p>
<p>FHORM支持如下主要特性：</p>
<ul>
<li>基于Python元类的对象-关系映射模型定义语法</li>
<li><code>select, insert, update, delete</code>操作</li>
<li>可替换的数据库后端</li>
<li>基于运算符重载的便捷查询条件书写</li>
<li>透明的线程池使用</li>
<li>支持快速模型元数据</li>
</ul>
<h3 id="模型元数据服务通用视图支持">模型元数据服务：通用视图支持</h3>
<p>为了实现ORM高度灵活、自省的特性，我们引进了<em>Python元类</em>的高级特性来实现代码：</p>
<p>ORM的核心类有如下三个：</p>
<ul>
<li>
<p><code>Field</code></p>
<p>代表关系型数据库中表的“列”的对象的基类。ORM预定义了大量的<code>Field</code>来表示
许多数据库的类型比如<code>CharField</code>, <code>IntegerField</code>, <code>BlobField</code>。</p>
<p>完整的Field列表详见源代码。</p>
</li>
<li>
<p><code>Model</code></p>
<p>用于描述关系数据库中元组到Python对象的映射的基类。</p>
<p>定义映射时需要将适当类型的<code>Field</code>绑定到适当的属性名上，需要与数据库中的表意义对应。</p>
<p>Model的实例就是表示一个具体的数据对象，通常是有数据库中的一行映射而来的。</p>
</li>
<li>
<p><code>ModelMetaClass</code></p>
<p><strong>自定义的元类，作为<code>Model</code>类的元类</strong>。它负责自动在Class本身构造（代码启动）的阶段收集Model的类成员属性，从而实现透明地使用Model的元数据的目的。</p>
</li>
</ul>
<p>以下是一则使用ORM定义映射模型的例子（摘自本项目）：</p>
<pre><code class="language-python"><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span>(<span class="hljs-params">Model</span>):</span>
    __tablename__ = <span class="hljs-string">&#x27;post&#x27;</span>
    pid = AutoField(primary_key=<span class="hljs-literal">True</span>,label=<span class="hljs-string">&quot;PID&quot;</span>)
    hot_value = IntegerField(label=<span class="hljs-string">&quot;Hot Value&quot;</span>)
    title = CharField(label=<span class="hljs-string">&quot;Title&quot;</span>)
    content = TextField(label=<span class="hljs-string">&quot;Content&quot;</span>)
    post_time = DatetimeField(label=<span class="hljs-string">&quot;Post Time&quot;</span>)
    last_modified_time = DatetimeField(label=<span class="hljs-string">&quot;Last Modified&quot;</span>)
    poster_uid = ForeignField(ForumUser, label=<span class="hljs-string">&quot;Poster UID&quot;</span>)
</div></code></pre>
<p><code>ModelMetaClass</code>的实现：</p>
<pre><code class="language-python"><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelMetaClass</span>(<span class="hljs-params">type</span>):</span>
    <span class="hljs-string">&#x27;&#x27;&#x27;
    Meta class for Model

    Mainly works to generate meta info from model definition
    &#x27;&#x27;&#x27;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__new__</span>(<span class="hljs-params">cls, cls_name, cls_bases, cls_attrs</span>):</span>
        <span class="hljs-comment"># collect fields and setup descriptors</span>
        pk = []
        default = {}
        fields_info = []
        fields_name = []
        <span class="hljs-keyword">for</span> idx, (attr_name, attr) <span class="hljs-keyword">in</span> enumerate(cls_attrs.items()):
            <span class="hljs-keyword">if</span> issubclass(type(attr), Field):
                attr.name = attr_name
                
                info = attr.get_info()
                info[<span class="hljs-string">&#x27;idx&#x27;</span>] = idx
                info[<span class="hljs-string">&#x27;name&#x27;</span>] = attr_name
                fields_info.append(info)
                fields_name.append(attr_name)
                <span class="hljs-keyword">if</span> attr.primary_key:
                    pk.append(attr_name)
                <span class="hljs-keyword">if</span> hasattr(attr, <span class="hljs-string">&#x27;default&#x27;</span>):
                    default[attr_name] = attr.default
        cls_attrs[<span class="hljs-string">&#x27;__fields__&#x27;</span>] = tuple(fields_name)
        cls_attrs[<span class="hljs-string">&#x27;__default__&#x27;</span>] = default
        cls_attrs[<span class="hljs-string">&#x27;__model_info__&#x27;</span>] = {
            <span class="hljs-string">&#x27;pk&#x27;</span>: pk,
            <span class="hljs-string">&#x27;fields&#x27;</span>: fields_info,
            <span class="hljs-string">&#x27;default&#x27;</span>: default,
        }

        <span class="hljs-comment"># handle primary key</span>
        <span class="hljs-keyword">if</span> cls_name != <span class="hljs-string">&#x27;Model&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> pk:
            <span class="hljs-keyword">raise</span> ORMError(<span class="hljs-string">&#x27;No primary key specified.&#x27;</span>)
        cls_attrs[<span class="hljs-string">&#x27;__pk__&#x27;</span>] = tuple(pk)

        <span class="hljs-comment"># set table name</span>
        cls_attrs.setdefault(<span class="hljs-string">&#x27;__tablename__&#x27;</span>, cls_name)

        model = super().__new__(cls, cls_name, cls_bases, cls_attrs)
        <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> cls_attrs.values():
            <span class="hljs-keyword">if</span> issubclass(type(attr), Field):
                attr.model = model
        <span class="hljs-keyword">return</span> model
</div></code></pre>
<h3 id="psycopg2python与opengauss数据库通信">Psycopg2：Python与openGauss数据库通信</h3>
<p>openGauss的引擎主体采用的是开源的PostgreSQL的引擎。我们采用PostgreSQL的Python客户端<code>Psycopg2</code>包来支持Python和openGauss的通信。</p>
<p>Psycopg2支持一些高级的特性，比如自动将<code>timestamp</code>类型转换成数据Python的<code>datetime</code>类型</p>
<h3 id="engine可替换的数据库后端">Engine：可替换的数据库后端</h3>
<p>ORM使用一层名为<code>Engine</code>的抽象实现可替换的数据库后端。</p>
<p>在ORM中，<strong>通过调用给定Engine的<code>select, insert, update, delete</code>方法并传入请求参数来存取数据</strong>。</p>
<p>在Engine中，核心是需要从传入参数构造SQL语句，本项目的实现如下：</p>
<pre><code class="language-python"><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">query2sql</span>(<span class="hljs-params">query</span>):</span>
        <span class="hljs-string">&#x27;&#x27;&#x27;
        required:
            - method
            - tablename
        optional:
            - condition
            - agg
            - orderby
            - orderby_desc
            - limit
            - offset
            - join
        &#x27;&#x27;&#x27;</span>
        <span class="hljs-keyword">if</span> query[<span class="hljs-string">&#x27;method&#x27;</span>] == <span class="hljs-string">&#x27;select&#x27;</span>:
            tpl = <span class="hljs-string">&#x27;select {agg_str} from {tablename}&#x27;</span>

            agg = query.get(<span class="hljs-string">&#x27;agg&#x27;</span>)
            <span class="hljs-keyword">if</span> agg <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                agg_str = <span class="hljs-string">f&#x27;<span class="hljs-subst">{agg}</span>(*)&#x27;</span>
            <span class="hljs-keyword">else</span>:
                agg_str = <span class="hljs-string">&#x27;*&#x27;</span>
            join = query.get(<span class="hljs-string">&#x27;join&#x27;</span>)
            <span class="hljs-keyword">if</span> join:
                table1 = query[<span class="hljs-string">&#x27;tablename&#x27;</span>]
                table2 = join[<span class="hljs-string">&#x27;join_model&#x27;</span>].__tablename__
                tablename = <span class="hljs-string">f&quot;<span class="hljs-subst">{table1}</span> join <span class="hljs-subst">{table2}</span> on <span class="hljs-subst">{table1}</span>.<span class="hljs-subst">{join[<span class="hljs-string">&#x27;field1&#x27;</span>]}</span> = <span class="hljs-subst">{table2}</span>.<span class="hljs-subst">{join[<span class="hljs-string">&#x27;field2&#x27;</span>]}</span>&quot;</span>
            <span class="hljs-keyword">else</span>:
                tablename = query[<span class="hljs-string">&#x27;tablename&#x27;</span>]
            tpl = tpl.format(
                tablename=tablename,
                agg_str=agg_str
            )

            condition = query.get(<span class="hljs-string">&#x27;condition&#x27;</span>)

            <span class="hljs-keyword">if</span> condition:
                <span class="hljs-string">&#x27;FIXME: not general&#x27;</span>
                tpl += <span class="hljs-string">f&#x27; where <span class="hljs-subst">{condition}</span>&#x27;</span>

            orderby = query.get(<span class="hljs-string">&#x27;orderby&#x27;</span>)
            desc = query.get(<span class="hljs-string">&#x27;orderby_desc&#x27;</span>)
            <span class="hljs-keyword">if</span> orderby:
                tpl += <span class="hljs-string">f&#x27; order by <span class="hljs-subst">{orderby}</span> <span class="hljs-subst">{<span class="hljs-string">&quot;desc&quot;</span> <span class="hljs-keyword">if</span> desc <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;asc&quot;</span>}</span>&#x27;</span>

            limit = query.get(<span class="hljs-string">&#x27;limit&#x27;</span>)
            <span class="hljs-keyword">if</span> limit:
                tpl += <span class="hljs-string">f&#x27; limit <span class="hljs-subst">{limit}</span>&#x27;</span>

            offset = query.get(<span class="hljs-string">&#x27;offset&#x27;</span>)
            <span class="hljs-keyword">if</span> offset:
                tpl += <span class="hljs-string">f&#x27; offset <span class="hljs-subst">{offset}</span>&#x27;</span>
            print(query)
            print(tpl)
            <span class="hljs-keyword">return</span> tpl, query.get(<span class="hljs-string">&#x27;condition_value&#x27;</span>, ())
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> <span class="hljs-built_in">NotImplemented</span>()
</div></code></pre>
<p>本项目只实现了openGauss的Engine，但只要编码更多的Engine，业务逻辑层可以无缝迁移到各种数据库后端上。</p>
<h3 id="基于连接池的数据库会话">基于连接池的数据库会话</h3>
<ul>
<li>
<p>连接池</p>
<p>每次后端发起请求都建立连接的话非常低效。我们采用<em>连接池</em>来解决这个问题。</p>
<p>连接池并发并维持一系列的连接；每次后端代码需要就取一个连接出来使用。连接使用结束并不断开而是释放交还连接池。</p>
</li>
<li>
<p>RAII语义</p>
<p>使用连接池的隐患是资源泄露：编码时不小心忘记交还连接，会导致连接池中的连接迅速耗尽。</p>
<p>一个解决方案是：采用RAII语义的<em>会话</em>抽象来管理连接。利用析构函数：每次会话对象被回收，就自动释放连接。</p>
<p>实现如下：</p>
<pre><code class="language-python"><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DBSession</span>:</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, engine: Engine</span>):</span>
      self.engine = engine
      self.conn = self.engine.getconn()
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span>
      self.conn.commit()
      self.engine.putconn(self.conn)
</div></code></pre>
</li>
</ul>
<h2 id="后端设计">后端设计</h2>
<h3 id="微服务架构">微服务架构</h3>
<p>后端架构采用<em>微服务</em>架构，将系统业务构建为可以独立运行、独立测试、独立部署的微服务。</p>
<p>在我们的应用中，我们仅对服务进行了拆分，没有对数据库进行拆分。</p>
<p>本项目基于这一思想拆分出多组服务接口。以下摘录部分：</p>
<p>对象元数据：</p>
<ul>
<li><code>/api/v1/model/&lt;model:model&gt;/</code></li>
</ul>
<p>对象CRUD：</p>
<ul>
<li><code>/api/v1/object/&lt;model:model&gt;/</code></li>
</ul>
<p>登录服务：</p>
<ul>
<li><code>/api/v1/auth/login/</code></li>
</ul>
<p>情感推断服务：</p>
<ul>
<li><code>/api/v1/ml/infer_user/&lt;string:uid&gt;/</code></li>
</ul>
<p>点击记录服务：</p>
<ul>
<li><code>/api/v1/log/tag_access/&lt;string:tname&gt;</code></li>
</ul>
<p>话题热度统计服务：</p>
<ul>
<li><code>/api/v1/hot/tag_hot/&lt;string:tname&gt;/</code></li>
</ul>
<p>完整的后端接口列表参见附件中的服务接口列表文档(<a href="http://api.html">api.md</a>)。</p>
<h3 id="restful接口">RESTful接口</h3>
<p>RESTful是一种网络应用程序的设计风格和开发方式，基于HTTP。</p>
<p>RESTful特点包括：</p>
<ol>
<li>每一个URI代表1种资源；</li>
<li>客户端使用GET、POST、PUT、DELETE4个表示操作方式的动词对服务端资源进行操作：GET用来获取资源，POST用来新建资源（也可以用于更新资源），PUT用来更新资源，DELETE用来删除资源；</li>
<li>通过操作资源的表现形式来操作资源；</li>
<li>客户端与服务端之间的交互在请求之间是无状态的，从客户端到服务端的每个请求都必须包含理解请求所必需的信息。</li>
</ol>
<p>RESTful的主要优势：</p>
<ol>
<li>统一接口，语义清晰：使用HTTP方法和“资源”的表示形式来操作，<strong>尤其适合实现数据对象的CRUD</strong></li>
<li>穿透性好：HTTP协议可以穿透大多数的局域网，便于后端在广域网上为用户提供服务</li>
<li>缓存友好：相比使用query的URI，RESTful请求更有利于Web缓存和CDN对数据进行缓存</li>
</ol>
<h3 id="数据对象通用crud服务">数据对象通用CRUD服务</h3>
<p>本项目设计了一组RESTful接口用于支持数据库中任意数据对象（元组）的增删改查操作。接口列表如下：</p>
<p>查询表的元数据：</p>
<ul>
<li><code>/api/v1/model/</code></li>
<li><code>/api/v1/model/&lt;model:model&gt;/</code></li>
</ul>
<p>数据对象的增删改查：</p>
<ul>
<li>对象列表：    <code>GET /api/v1/object/&lt;model:model&gt;/</code></li>
<li>查询单个对象： <code>GET /api/v1/object/&lt;model:model&gt;/&lt;key:pk&gt;/</code></li>
<li>增加对象：    <code>POST /api/v1/object/&lt;model:model&gt;/</code></li>
<li>修改对象：    <code>PUT /api/v1/object/&lt;model:model&gt;/&lt;key:pk&gt;/</code></li>
<li>删除对象：    <code>DELETE /api/v1/object/&lt;model:model&gt;/&lt;key:pk&gt;/</code></li>
</ul>
<p>详细的接口参数规范详见接口文档：<code>api_crud.md</code></p>
<p>可以看出在接口设计中，我们遵循了一半RESTful方法的语义：</p>
<ul>
<li><code>POST</code>是非幂等的操作</li>
<li><code>PUT</code>是幂等的操作（可以重传）</li>
</ul>
<h3 id="后端代码的数据库访问">后端代码的数据库访问</h3>
<h3 id="基本论坛服务">基本论坛服务</h3>
<p>除去数据对象的CRUD，论坛需要提供如下基本服务：</p>
<ul>
<li>查询用户的所有帖子</li>
<li>查询给定话题管理的所有帖子</li>
<li>查询帖子的所有标签</li>
<li>查询群组的所有成员</li>
<li>等等</li>
</ul>
<p>这些都逐一通过ORM的<code>join</code>选项并开放相应的接口来实现。</p>
<h3 id="登录-鉴权服务">登录-鉴权服务</h3>
<p>登录-鉴权服务的关键在于：</p>
<ul>
<li>根据用户的口令鉴别用户身份和权限</li>
<li><strong>将用户登录的状态保存到Cookie上</strong></li>
</ul>
<p>本项目基于Cookie来实现登录。其中我们将用户状态信息加密生成token保存为Cookie，用户端则依靠Vuex跨组件使用token，
请求时带上Cookie即可使用权限。</p>
<h3 id="点击记录服务">点击记录服务</h3>
<p>我们开放了一个服务用于计数每一个话题（标签）的点击：</p>
<p><code>/api/v1/log/tag_access/&lt;string:tname&gt;</code></p>
<p><strong>点击日志会记录到数据库中。点击日志会记录是哪一个用户在哪一个时间访问了哪一个日志。</strong></p>
<h3 id="点击热度分析">点击热度分析</h3>
<p>有两种方式实现计算给定长度滑动窗口中点击次数的方法：</p>
<ol>
<li>
<p>SQL窗口函数</p>
<p><code>select count(*) over (partition by access_time) from tag_log</code></p>
</li>
<li>
<p>Pandas窗口函数</p>
<p><code>df.rolling('1D').count()</code></p>
</li>
</ol>
<p>我们两种都实现了。</p>
<p>我们开发了一个接口让前端获取相应的热度变化曲线。</p>
<h2 id="附录1系统界面完整演示">附录1：系统界面完整演示：</h2>
<p>数据管理界面：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage1.PNG" alt="App View Manage"></p>
<p>基于SQL的快速表格排序：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage2.PNG" alt="App View Manage"></p>
<p>服务端分页：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage3.PNG" alt="App View Manage"></p>
<p>服务端分页演示，每页15条切换到每页5条：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage4.PNG" alt="App View Manage"></p>
<p>告示信息：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\manage5.PNG" alt="App View Manage"></p>
<p>创建失败的告示信息：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\create.PNG" alt="App View Manage"></p>
<p>创建成功的告示信息：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\create2.PNG" alt="App View Manage"></p>
<p>新建对象表单：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form1.PNG" alt="App View Form"></p>
<p>日期选择组件：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form2.PNG" alt="App View Form"></p>
<p>基于正则表达式的表单验证：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form3.PNG" alt="App View Form"></p>
<p>验证通过：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form4.PNG" alt="App View Form"></p>
<p>对枚举类型自动采用select组件：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\form5.PNG" alt="App View Form"></p>
<p>帖子列表：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\posts.PNG" alt="App View Post"></p>
<p>发帖界面：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\post_edit.PNG" alt="App View Login"></p>
<p>个人信息中心：</p>
<p><img src="file:///e:\db_ws\project\forum_humor\report\user_info.PNG" alt="App View User Info"></p>
<h2 id="附录2orm核心实现">附录2：ORM核心实现</h2>
<p><code>ModelMetaClass</code>的实现：</p>
<pre><code class="language-python"><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelMetaClass</span>(<span class="hljs-params">type</span>):</span>
    <span class="hljs-string">&#x27;&#x27;&#x27;
    Meta class for Model

    Mainly works to generate meta info from model definition
    &#x27;&#x27;&#x27;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__new__</span>(<span class="hljs-params">cls, cls_name, cls_bases, cls_attrs</span>):</span>
        <span class="hljs-comment"># collect fields and setup descriptors</span>
        pk = []
        default = {}
        fields_info = []
        fields_name = []
        <span class="hljs-keyword">for</span> idx, (attr_name, attr) <span class="hljs-keyword">in</span> enumerate(cls_attrs.items()):
            <span class="hljs-keyword">if</span> issubclass(type(attr), Field):
                attr.name = attr_name
                
                info = attr.get_info()
                info[<span class="hljs-string">&#x27;idx&#x27;</span>] = idx
                info[<span class="hljs-string">&#x27;name&#x27;</span>] = attr_name
                fields_info.append(info)
                fields_name.append(attr_name)
                <span class="hljs-keyword">if</span> attr.primary_key:
                    pk.append(attr_name)
                <span class="hljs-keyword">if</span> hasattr(attr, <span class="hljs-string">&#x27;default&#x27;</span>):
                    default[attr_name] = attr.default
        cls_attrs[<span class="hljs-string">&#x27;__fields__&#x27;</span>] = tuple(fields_name)
        cls_attrs[<span class="hljs-string">&#x27;__default__&#x27;</span>] = default
        cls_attrs[<span class="hljs-string">&#x27;__model_info__&#x27;</span>] = {
            <span class="hljs-string">&#x27;pk&#x27;</span>: pk,
            <span class="hljs-string">&#x27;fields&#x27;</span>: fields_info,
            <span class="hljs-string">&#x27;default&#x27;</span>: default,
        }

        <span class="hljs-comment"># handle primary key</span>
        <span class="hljs-keyword">if</span> cls_name != <span class="hljs-string">&#x27;Model&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> pk:
            <span class="hljs-keyword">raise</span> ORMError(<span class="hljs-string">&#x27;No primary key specified.&#x27;</span>)
        cls_attrs[<span class="hljs-string">&#x27;__pk__&#x27;</span>] = tuple(pk)

        <span class="hljs-comment"># set table name</span>
        cls_attrs.setdefault(<span class="hljs-string">&#x27;__tablename__&#x27;</span>, cls_name)

        model = super().__new__(cls, cls_name, cls_bases, cls_attrs)
        <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> cls_attrs.values():
            <span class="hljs-keyword">if</span> issubclass(type(attr), Field):
                attr.model = model
        <span class="hljs-keyword">return</span> model
</div></code></pre>
<p>Model的实现：</p>
<pre><code class="language-python"><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span>(<span class="hljs-params">metaclass=ModelMetaClass</span>):</span>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_field</span>(<span class="hljs-params">cls, field_name</span>):</span>
        <span class="hljs-keyword">return</span> getattr(cls, field_name)
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_tuple</span>(<span class="hljs-params">cls, row</span>):</span>
        <span class="hljs-string">&#x27;&#x27;&#x27;
        Factory method

        build object from tuple row
        &#x27;&#x27;&#x27;</span>
        <span class="hljs-keyword">return</span> cls(dict(zip(cls.__fields__, row)))
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_fmtstr</span>(<span class="hljs-params">cls</span>) -&gt; str:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;,&#x27;</span>.join(map(<span class="hljs-keyword">lambda</span> pk: <span class="hljs-string">f&#x27;<span class="hljs-subst">{pk}</span>=<span class="hljs-subst">{cls.get_field(pk).get_fmt()}</span>&#x27;</span>, cls.__pk__))
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_model_info</span>(<span class="hljs-params">cls</span>):</span>
        <span class="hljs-keyword">return</span> cls.__model_info__

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, data, **kwargs</span>):</span>
        <span class="hljs-string">&#x27;&#x27;&#x27;
        Basic Initialization

        More builds see factory methods
        &#x27;&#x27;&#x27;</span>
        self._data = self.__default__.copy()
        self._data.update(data)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self</span>) -&gt; dict:</span>
        <span class="hljs-keyword">return</span> self._data
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key</span>(<span class="hljs-params">self</span>) -&gt; dict:</span>
        <span class="hljs-keyword">return</span> dict(filter(<span class="hljs-keyword">lambda</span> p: p[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> self.__pk__, self._data.items()))
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_keyval</span>(<span class="hljs-params">self</span>) -&gt; tuple:</span>
        <span class="hljs-keyword">return</span> tuple(self.get_key().values())
    
    
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to_json</span>(<span class="hljs-params">self</span>) -&gt; dict:</span>
        <span class="hljs-keyword">return</span> self._data
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>) -&gt; str:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;&lt;<span class="hljs-subst">{self.__class__.__name__}</span>: <span class="hljs-subst">{self.get_data()}</span>&gt;&#x27;</span>
</div></code></pre>
<p><code>Field</code>的实现：</p>
<pre><code class="language-python"><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Field</span>:</span>
    __fieldtype__ = <span class="hljs-string">&#x27;unknown&#x27;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        self.name = kwargs.get(<span class="hljs-string">&#x27;name&#x27;</span>, self.__class__.__name__)
        self.allow_null = kwargs.get(<span class="hljs-string">&#x27;null&#x27;</span>, <span class="hljs-literal">True</span>)
        self.model = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> self.allow_null == <span class="hljs-literal">False</span> \
            <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;default&#x27;</span> <span class="hljs-keyword">in</span> kwargs \
                <span class="hljs-keyword">and</span> kwargs[<span class="hljs-string">&#x27;default&#x27;</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> ORMError(<span class="hljs-string">&#x27;null not allowed&#x27;</span>)
        self.default = kwargs.get(<span class="hljs-string">&#x27;default&#x27;</span>, <span class="hljs-literal">None</span>)
        self.primary_key = kwargs.get(<span class="hljs-string">&#x27;primary_key&#x27;</span>, <span class="hljs-literal">False</span>) 
        self.label = kwargs.get(<span class="hljs-string">&#x27;label&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__get__</span>(<span class="hljs-params">self, instance, owner</span>):</span>
        <span class="hljs-keyword">if</span> instance <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            instance._data[self.name]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> self
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__set__</span>(<span class="hljs-params">self, instance, value</span>):</span>
        instance._data[self.name] = value
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_info</span>(<span class="hljs-params">self</span>):</span>
        res = {
            <span class="hljs-string">&#x27;type&#x27;</span>: self.__fieldtype__,
            <span class="hljs-string">&#x27;label&#x27;</span>: getattr(self, <span class="hljs-string">&#x27;label&#x27;</span>, self.name)
        }
        <span class="hljs-keyword">if</span> hasattr(self, <span class="hljs-string">&#x27;default&#x27;</span>):
            res[<span class="hljs-string">&#x27;default&#x27;</span>] = self.default
        <span class="hljs-keyword">return</span> res

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_fmt</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;%s&#x27;</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__eq__</span>(<span class="hljs-params">self, other</span>):</span>
        <span class="hljs-keyword">if</span> issubclass(type(other), Field):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">{self.name}</span> = <span class="hljs-subst">{other.name}</span>&#x27;</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">{self.name}</span> = <span class="hljs-subst">{other}</span>&#x27;</span>
</div></code></pre>
<p>从请求字典构造SQL请求的实现：</p>
<pre><code class="language-python"><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">query2sql</span>(<span class="hljs-params">query</span>):</span>
        <span class="hljs-string">&#x27;&#x27;&#x27;
        required:
            - method
            - tablename
        optional:
            - condition
            - agg
            - orderby
            - orderby_desc
            - limit
            - offset
            - join
        &#x27;&#x27;&#x27;</span>
        <span class="hljs-keyword">if</span> query[<span class="hljs-string">&#x27;method&#x27;</span>] == <span class="hljs-string">&#x27;select&#x27;</span>:
            tpl = <span class="hljs-string">&#x27;select {agg_str} from {tablename}&#x27;</span>

            agg = query.get(<span class="hljs-string">&#x27;agg&#x27;</span>)
            <span class="hljs-keyword">if</span> agg <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                agg_str = <span class="hljs-string">f&#x27;<span class="hljs-subst">{agg}</span>(*)&#x27;</span>
            <span class="hljs-keyword">else</span>:
                agg_str = <span class="hljs-string">&#x27;*&#x27;</span>
            join = query.get(<span class="hljs-string">&#x27;join&#x27;</span>)
            <span class="hljs-keyword">if</span> join:
                table1 = query[<span class="hljs-string">&#x27;tablename&#x27;</span>]
                table2 = join[<span class="hljs-string">&#x27;join_model&#x27;</span>].__tablename__
                tablename = <span class="hljs-string">f&quot;<span class="hljs-subst">{table1}</span> join <span class="hljs-subst">{table2}</span> on <span class="hljs-subst">{table1}</span>.<span class="hljs-subst">{join[<span class="hljs-string">&#x27;field1&#x27;</span>]}</span> = <span class="hljs-subst">{table2}</span>.<span class="hljs-subst">{join[<span class="hljs-string">&#x27;field2&#x27;</span>]}</span>&quot;</span>
            <span class="hljs-keyword">else</span>:
                tablename = query[<span class="hljs-string">&#x27;tablename&#x27;</span>]
            tpl = tpl.format(
                tablename=tablename,
                agg_str=agg_str
            )

            condition = query.get(<span class="hljs-string">&#x27;condition&#x27;</span>)

            <span class="hljs-keyword">if</span> condition:
                <span class="hljs-string">&#x27;FIXME: not general&#x27;</span>
                tpl += <span class="hljs-string">f&#x27; where <span class="hljs-subst">{condition}</span>&#x27;</span>

            orderby = query.get(<span class="hljs-string">&#x27;orderby&#x27;</span>)
            desc = query.get(<span class="hljs-string">&#x27;orderby_desc&#x27;</span>)
            <span class="hljs-keyword">if</span> orderby:
                tpl += <span class="hljs-string">f&#x27; order by <span class="hljs-subst">{orderby}</span> <span class="hljs-subst">{<span class="hljs-string">&quot;desc&quot;</span> <span class="hljs-keyword">if</span> desc <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;asc&quot;</span>}</span>&#x27;</span>

            limit = query.get(<span class="hljs-string">&#x27;limit&#x27;</span>)
            <span class="hljs-keyword">if</span> limit:
                tpl += <span class="hljs-string">f&#x27; limit <span class="hljs-subst">{limit}</span>&#x27;</span>

            offset = query.get(<span class="hljs-string">&#x27;offset&#x27;</span>)
            <span class="hljs-keyword">if</span> offset:
                tpl += <span class="hljs-string">f&#x27; offset <span class="hljs-subst">{offset}</span>&#x27;</span>
            print(query)
            print(tpl)
            <span class="hljs-keyword">return</span> tpl, query.get(<span class="hljs-string">&#x27;condition_value&#x27;</span>, ())
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> <span class="hljs-built_in">NotImplemented</span>()
</div></code></pre>

    </body>
    </html>